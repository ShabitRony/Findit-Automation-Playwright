name: Node.js CI

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    # strategy:
    #   matrix:
    #     node-version: [20.x]

    steps:
      # ‚úÖ Checkout your repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # ‚úÖ Setup Node.js
      - name: Setup NodeJS
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ‚úÖ Install dependencies
      - name: Install dependencies
        run: npm ci

      # ‚úÖ Build project (if applicable)
      - name: Build project (if applicable)
        run: npm run build --if-present

      # ‚úÖ Install Playwright browsers
      - name: Install Playwright Browsers
        run: npx playwright install
      # ‚úÖ Cache Allure CLI (Prevents downloading Allure every run)
      - name: Cache Allure CLI
        id: cache-allure
        uses: actions/cache@v3
        with:
          path: /opt/allure-2.24.0
          key: allure-${{ runner.os }}-2.24.0
          restore-keys: allure-${{ runner.os }}-

      - name: Install Allure CLI
        run: |
          echo "üì¶ Installing Allure CLI..."
          sudo apt update
          sudo apt install -y curl unzip

          # ‚úÖ Download a fixed version instead of latest
          echo "üì• Downloading Allure (Fixed Version)..."
          curl -L -o allure.tgz https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.tgz

          echo "üìÇ Extracting Allure..."
          tar -zxvf allure.tgz -C /opt/ || { echo "‚ùå Extraction failed!"; exit 1; }

          echo "üîó Creating Symlink for Allure..."
          sudo ln -s /opt/allure-2.24.0/bin/allure /usr/local/bin/allure

          echo "‚úÖ Installed Allure CLI Version: $(allure --version)"

      - name: Clear Previous Allure Results
        run: |
          echo "üßπ Cleaning previous Allure results..."
          rm -rf allure-results allure-report allure-history || true
          mkdir -p allure-results allure-report allure-history  # ‚úÖ Ensure fresh directories exist

      # ‚úÖ Run Playwright tests
      - name: Run Playwright Tests
        run: npx playwright test

      # # ‚úÖ Upload Playwright HTML Report (always run, even if tests fail)
      # - name: Upload Playwright HTML Report
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: playwright-report
      #     path: playwright-report

      # # ‚úÖ Upload Playwright Videos (always run)
      # - name: Upload Playwright Videos
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: playwright-videos
      #     path: test-results/**/video.webm
      - name: Generate Fresh Allure Report
        if: always()
        run: |
          echo "üìä Generating Allure Report..."
          allure generate allure-results --clean -o allure-report  # ‚úÖ Generate new report
          ls -lah allure-report

      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report

      # ‚úÖ Upload Allure Report Videos (from allure-report)
      - name: Upload Allure Report Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-videos
          path: allure-report/data/attachments/*.webm

      - name: Upload Failure Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: failure-screenshots
          path: allure-report/data/attachments/*.png  # ‚úÖ Upload screenshots if they exist
          retention-days: 7